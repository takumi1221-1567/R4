# =====================================================================
# deploy.yml — R4 Project GitHub Actions 自動デプロイ
# =====================================================================
# トリガー: main ブランチへの push
# 処理:
#   1. Unity WebGL ビルド (GameCI 使用)
#   2. Cloudflare Pages へデプロイ
#
# 必要な GitHub Secrets:
#   UNITY_LICENSE          - Unity ライセンス XML (Personal/Pro)
#   UNITY_EMAIL            - Unity アカウントのメールアドレス
#   UNITY_PASSWORD         - Unity アカウントのパスワード
#   CLOUDFLARE_API_TOKEN   - Cloudflare API トークン (Pages:Edit権限)
#   CLOUDFLARE_ACCOUNT_ID  - Cloudflare アカウント ID
# =====================================================================

name: R4 Build & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:   # 手動実行も可能

env:
  UNITY_PROJECT_PATH: unity
  BUILD_OUTPUT_PATH:  unity/Builds/WebGL
  CF_PROJECT_NAME:    r4-kyuroku

jobs:
  # ──────────────────────────────────────────────────────────────────
  # Job 1: Unity WebGL ビルド
  # ──────────────────────────────────────────────────────────────────
  build:
    name: Unity WebGL Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.UNITY_PROJECT_PATH }}/Library
          key:  unity-${{ hashFiles('**/ProjectSettings/ProjectVersion.txt') }}
          restore-keys: unity-

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE:  ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL:    ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath:        ${{ env.UNITY_PROJECT_PATH }}
          targetPlatform:     WebGL
          buildName:          R4_WebGL
          buildsPath:         Builds
          # WebGL テンプレート設定 (任意)
          # unityVersion: 2022.3.x
          customParameters: >-
            -define R4_PRODUCTION

      # ── WebGL 圧縮設定の無効化 (Cloudflare 互換のため) ──
      - name: Patch WebGL Compression
        run: |
          find ${{ env.BUILD_OUTPUT_PATH }} -name "*.br" -delete
          find ${{ env.BUILD_OUTPUT_PATH }} -name "*.gz" -delete
          # gunzipが必要な場合:
          # find ${{ env.BUILD_OUTPUT_PATH }} -name "*.gz" -exec gunzip {} \;

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webgl-build
          path: ${{ env.BUILD_OUTPUT_PATH }}
          retention-days: 7

  # ──────────────────────────────────────────────────────────────────
  # Job 2: Cloudflare Pages デプロイ
  # ──────────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Cloudflare Pages
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url:  https://r4-kyuroku.pages.dev
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: webgl-build
          path: webgl-output

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken:  ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: >
            pages deploy webgl-output
            --project-name=${{ env.CF_PROJECT_NAME }}
            --branch=main
            --commit-dirty=true

      - name: Post Deploy URL
        run: |
          echo "✅ デプロイ完了!"
          echo "URL: https://${{ env.CF_PROJECT_NAME }}.pages.dev"
